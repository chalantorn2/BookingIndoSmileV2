<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Information Updater</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
      }
      .section {
        margin: 20px 0;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
      }
      .section h3 {
        color: #333;
        margin-top: 0;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-primary:hover {
        background: #0056b3;
      }
      .btn-success:hover {
        background: #1e7e34;
      }
      .log {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        height: 300px;
        overflow-y: auto;
        font-family: monospace;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }
      .stat-box {
        background: #e9ecef;
        padding: 10px;
        text-align: center;
        border-radius: 5px;
      }
      .new-items {
        background: #fff3cd;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Information Updater</h1>
      <p>‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô information table</p>

      <div class="section">
        <h3>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
        <div class="stats" id="currentStats">
          <div class="stat-box">Agent: <span id="agentCount">-</span></div>
          <div class="stat-box">
            Tour Types: <span id="tourTypeCount">-</span>
          </div>
          <div class="stat-box">
            Transfer Types: <span id="transferTypeCount">-</span>
          </div>
          <div class="stat-box">
            Tour Recipients: <span id="tourRecipientCount">-</span>
          </div>
          <div class="stat-box">
            Transfer Recipients: <span id="transferRecipientCount">-</span>
          </div>
          <div class="stat-box">Places: <span id="placeCount">-</span></div>
        </div>
        <button class="btn-primary" onclick="analyzeData()">
          üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
      </div>

      <div class="section" id="analysisSection" style="display: none">
        <h3>üÜï ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°</h3>
        <div id="newDataPreview"></div>
        <button class="btn-success" onclick="addMissingData()">
          ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </button>
      </div>

      <div class="section">
        <h3>üìù Log</h3>
        <div class="log" id="logArea">Ready...</div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://itehwlzixbylnmxjxcmv.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWh3bHppeGJ5bG5teGp4Y212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwNzI0NjMsImV4cCI6MjA2MzY0ODQ2M30.y4qOApQEknv_e9kozwPznOqCqAoxqFdsxaUbWsI7Xts";

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      let existingData = {};
      let newData = {
        tour_type: new Set(),
        transfer_type: new Set(),
        tour_recipient: new Set(),
        transfer_recipient: new Set(),
        place: new Set(),
      };

      function log(message) {
        const logArea = document.getElementById("logArea");
        const time = new Date().toLocaleTimeString();
        logArea.innerHTML += `[${time}] ${message}\n`;
        logArea.scrollTop = logArea.scrollHeight;
      }

      async function analyzeData() {
        log("üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

        try {
          // Load existing information
          await loadExistingInformation();

          // Analyze tour bookings
          await analyzeTourBookings();

          // Analyze transfer bookings
          await analyzeTransferBookings();

          // Show results
          showAnalysisResults();
        } catch (error) {
          log(`‚ùå Error: ${error.message}`);
        }
      }

      async function loadExistingInformation() {
        log("üìö ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• information ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà...");

        const { data, error } = await supabase
          .from("information")
          .select("category, value");

        if (error) throw error;

        existingData = {
          agent: new Set(),
          tour_type: new Set(),
          transfer_type: new Set(),
          tour_recipient: new Set(),
          transfer_recipient: new Set(),
          place: new Set(),
        };

        data.forEach((item) => {
          if (existingData[item.category]) {
            existingData[item.category].add(item.value);
          }
        });

        // Update UI
        document.getElementById("agentCount").textContent =
          existingData.agent.size;
        document.getElementById("tourTypeCount").textContent =
          existingData.tour_type.size;
        document.getElementById("transferTypeCount").textContent =
          existingData.transfer_type.size;
        document.getElementById("tourRecipientCount").textContent =
          existingData.tour_recipient.size;
        document.getElementById("transferRecipientCount").textContent =
          existingData.transfer_recipient.size;
        document.getElementById("placeCount").textContent =
          existingData.place.size;

        log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à: ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
      }

      async function analyzeTourBookings() {
        log("üèñÔ∏è ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå tour bookings...");

        const { data, error } = await supabase
          .from("tour_bookings")
          .select("tour_type, send_to, tour_hotel");

        if (error) throw error;

        data.forEach((booking) => {
          // Tour types
          if (
            booking.tour_type &&
            !existingData.tour_type.has(booking.tour_type)
          ) {
            newData.tour_type.add(booking.tour_type);
          }

          // Tour recipients
          if (
            booking.send_to &&
            !existingData.tour_recipient.has(booking.send_to)
          ) {
            newData.tour_recipient.add(booking.send_to);
          }

          // Places (hotels)
          if (
            booking.tour_hotel &&
            !existingData.place.has(booking.tour_hotel)
          ) {
            newData.place.add(booking.tour_hotel);
          }
        });

        log(`‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå tour bookings ‡πÄ‡∏™‡∏£‡πá‡∏à: ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
      }

      async function analyzeTransferBookings() {
        log("üöó ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå transfer bookings...");

        const { data, error } = await supabase
          .from("transfer_bookings")
          .select("transfer_type, send_to, pickup_location, drop_location");

        if (error) throw error;

        data.forEach((booking) => {
          // Transfer types
          if (
            booking.transfer_type &&
            !existingData.transfer_type.has(booking.transfer_type)
          ) {
            newData.transfer_type.add(booking.transfer_type);
          }

          // Transfer recipients
          if (
            booking.send_to &&
            !existingData.transfer_recipient.has(booking.send_to)
          ) {
            newData.transfer_recipient.add(booking.send_to);
          }

          // Places (pickup/drop locations)
          if (
            booking.pickup_location &&
            !existingData.place.has(booking.pickup_location)
          ) {
            newData.place.add(booking.pickup_location);
          }
          if (
            booking.drop_location &&
            !existingData.place.has(booking.drop_location)
          ) {
            newData.place.add(booking.drop_location);
          }
        });

        log(`‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå transfer bookings ‡πÄ‡∏™‡∏£‡πá‡∏à: ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
      }

      function showAnalysisResults() {
        const previewDiv = document.getElementById("newDataPreview");
        let html = "";

        Object.entries(newData).forEach(([category, items]) => {
          if (items.size > 0) {
            html += `
                        <div class="new-items">
                            <h4>${getCategoryName(category)} (${
              items.size
            } ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà)</h4>
                            <div style="max-height: 100px; overflow-y: auto; font-size: 14px;">
                                ${Array.from(items)
                                  .map((item) => `‚Ä¢ ${item}`)
                                  .join("<br>")}
                            </div>
                        </div>
                    `;
          }
        });

        if (html) {
          previewDiv.innerHTML = html;
          document.getElementById("analysisSection").style.display = "block";

          const totalNew = Object.values(newData).reduce(
            (sum, set) => sum + set.size,
            0
          );
          log(`üéØ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalNew} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        } else {
          previewDiv.innerHTML =
            '<p style="color: green;">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</p>';
          document.getElementById("analysisSection").style.display = "block";
          log("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
        }
      }

      function getCategoryName(category) {
        const names = {
          tour_type: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Tour",
          transfer_type: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Transfer",
          tour_recipient: "‡∏™‡πà‡∏á‡πÉ‡∏Ñ‡∏£ Tour",
          transfer_recipient: "‡∏™‡πà‡∏á‡πÉ‡∏Ñ‡∏£ Transfer",
          place: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà",
        };
        return names[category] || category;
      }

      async function addMissingData() {
        log("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà...");

        let totalAdded = 0;

        for (const [category, items] of Object.entries(newData)) {
          if (items.size > 0) {
            log(`üìù ‡πÄ‡∏û‡∏¥‡πà‡∏° ${getCategoryName(category)}...`);

            for (const value of items) {
              try {
                const { error } = await supabase.from("information").insert({
                  category: category,
                  value: value,
                  active: true,
                  created_at: new Date().toISOString(),
                  updated_at: new Date().toISOString(),
                });

                if (error) throw error;

                log(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${getCategoryName(category)}: ${value}`);
                totalAdded++;
              } catch (error) {
                log(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° ${value}: ${error.message}`);
              }
            }
          }
        }

        log(`üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalAdded} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

        // Refresh analysis
        setTimeout(() => {
          analyzeData();
        }, 1000);
      }

      // Auto analyze on load
      window.onload = () => {
        log("üîß Information Updater ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
      };
    </script>
  </body>
</html>
